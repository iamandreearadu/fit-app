<!-- ── INITIAL LOAD ── -->
<div *ngIf="loading" class="chat-loading">
  <mat-progress-spinner mode="indeterminate" diameter="40"></mat-progress-spinner>
  <span class="loading-label">Loading conversation…</span>
</div>

<!-- ── MAIN CHAT UI ── -->
<div *ngIf="!loading" class="chat-root">

  <!-- Messages area -->
  <div class="chat-window" #chatWindow>

    <!-- Empty state -->
    <div *ngIf="!facade.messages().length" class="empty-state">
      <mat-icon class="es-icon">auto_awesome</mat-icon>
      <div class="es-title">AI Assistant</div>
      <div class="es-sub">Ask anything about fitness, nutrition, workouts or health.</div>
    </div>

    <!-- Bubbles -->
    <ng-container *ngFor="let msg of facade.messages()">
      <div [ngClass]="msg.role === 'user' ? 'bubble user' : 'bubble ai'">
        <p class="msg-text">{{ msg.content }}</p>
        <img *ngIf="msg.imageUrl" [src]="msg.imageUrl" class="msg-img" alt="Uploaded image">
        <span class="msg-time">{{ msg.timestamp | date:'shortTime' }}</span>
      </div>
    </ng-container>

    <!-- Typing indicator -->
    <div *ngIf="facade.loading()" class="bubble ai typing-bubble">
      <span class="dot"></span>
      <span class="dot"></span>
      <span class="dot"></span>
    </div>

  </div>

  <!-- ── INPUT BAR ── -->
  <div class="input-bar">

    <button mat-icon-button class="upload-btn" type="button"
            (click)="fileInput.click()"
            [disabled]="facade.loading()"
            matTooltip="Upload image">
      <mat-icon>add_photo_alternate</mat-icon>
    </button>

    <input #fileInput type="file" accept="image/*" hidden (change)="onFileSelected($event)">

    <div class="textarea-wrap">
      <textarea
        class="chat-textarea"
        rows="1"
        [(ngModel)]="prompt"
        (keydown)="onKeyDown($event)"
        placeholder="Message AI Assistant…"
        [disabled]="facade.loading()">
      </textarea>
      <div *ngIf="imageFile" class="file-chip">
        <mat-icon class="file-chip-icon">image</mat-icon>
        <span class="file-chip-name">{{ imageFile.name }}</span>
      </div>
    </div>

    <button mat-icon-button class="send-btn" type="button"
            [disabled]="facade.loading() || (!prompt.trim() && !imageFile)"
            (click)="send()">
      <mat-icon>{{ facade.loading() ? 'hourglass_empty' : 'send' }}</mat-icon>
    </button>

  </div>

</div>
