<div *ngIf="loading()" class="wo-loading">
  <mat-progress-spinner mode="indeterminate" diameter="48"></mat-progress-spinner>
</div>

<div *ngIf="!loading()" class="wo-root">

  <!-- ── HEADER ── -->
  <div class="section-header">
    <h2 class="section-title">Workout Plans</h2>
    <p class="section-subtitle">Choose a training plan that fits your goals</p>
  </div>

  <!-- ── BACKDROP DIVS ── -->
  <div *ngIf="showTypeDropdown"  class="drop-bd" (click)="showTypeDropdown=false"></div>
  <div *ngIf="showLevelDropdown" class="drop-bd" (click)="showLevelDropdown=false"></div>
  <div *ngIf="showSortDropdown"  class="drop-bd" (click)="showSortDropdown=false"></div>

  <!-- ── CONTROLS BAR ── -->
  <div class="controls-bar">

    <div class="search-wrap">
      <mat-icon class="search-ico">search</mat-icon>
      <input class="search-input" placeholder="Search plans…"
             [ngModel]="search()" (ngModelChange)="search.set($event)" />
    </div>

    <!-- Type dropdown -->
    <div class="drop-wrap">
      <button class="drop-trigger" type="button"
              (click)="showTypeDropdown=!showTypeDropdown; showLevelDropdown=false; showSortDropdown=false">
        <span class="drop-label">{{ type() === 'all' ? 'All types' : (type() | titlecase) }}</span>
        <mat-icon class="drop-chevron">{{ showTypeDropdown ? 'expand_less' : 'expand_more' }}</mat-icon>
      </button>
      <div *ngIf="showTypeDropdown" class="drop-panel" (click)="$event.stopPropagation()">
        <button class="drop-opt" [class.drop-opt-active]="type()==='all'"    (click)="type.set('all');    showTypeDropdown=false">All types</button>
        <button class="drop-opt" [class.drop-opt-active]="type()==='home'"   (click)="type.set('home');   showTypeDropdown=false">Home</button>
        <button class="drop-opt" [class.drop-opt-active]="type()==='gym'"    (click)="type.set('gym');    showTypeDropdown=false">Gym</button>
        <button class="drop-opt" [class.drop-opt-active]="type()==='hybrid'" (click)="type.set('hybrid'); showTypeDropdown=false">Hybrid</button>
      </div>
    </div>

    <!-- Level dropdown -->
    <div class="drop-wrap">
      <button class="drop-trigger" type="button"
              (click)="showLevelDropdown=!showLevelDropdown; showTypeDropdown=false; showSortDropdown=false">
        <span class="drop-label">{{ level() === 'all' ? 'All levels' : (level() | titlecase) }}</span>
        <mat-icon class="drop-chevron">{{ showLevelDropdown ? 'expand_less' : 'expand_more' }}</mat-icon>
      </button>
      <div *ngIf="showLevelDropdown" class="drop-panel" (click)="$event.stopPropagation()">
        <button class="drop-opt" [class.drop-opt-active]="level()==='all'"          (click)="level.set('all');          showLevelDropdown=false">All levels</button>
        <button class="drop-opt" [class.drop-opt-active]="level()==='beginner'"     (click)="level.set('beginner');     showLevelDropdown=false">Beginner</button>
        <button class="drop-opt" [class.drop-opt-active]="level()==='intermediate'" (click)="level.set('intermediate'); showLevelDropdown=false">Intermediate</button>
        <button class="drop-opt" [class.drop-opt-active]="level()==='advanced'"     (click)="level.set('advanced');     showLevelDropdown=false">Advanced</button>
      </div>
    </div>

    <!-- Sort dropdown -->
    <div class="drop-wrap">
      <button class="drop-trigger" type="button"
              (click)="showSortDropdown=!showSortDropdown; showTypeDropdown=false; showLevelDropdown=false">
        <span class="drop-label">{{ sortLabel() }}</span>
        <mat-icon class="drop-chevron">{{ showSortDropdown ? 'expand_less' : 'expand_more' }}</mat-icon>
      </button>
      <div *ngIf="showSortDropdown" class="drop-panel" (click)="$event.stopPropagation()">
        <button class="drop-opt" [class.drop-opt-active]="sort()==='popular'"    (click)="sort.set('popular');    showSortDropdown=false">Popular</button>
        <button class="drop-opt" [class.drop-opt-active]="sort()==='price-asc'"  (click)="sort.set('price-asc');  showSortDropdown=false">Price ↑</button>
        <button class="drop-opt" [class.drop-opt-active]="sort()==='price-desc'" (click)="sort.set('price-desc'); showSortDropdown=false">Price ↓</button>
        <button class="drop-opt" [class.drop-opt-active]="sort()==='weeks-asc'"  (click)="sort.set('weeks-asc');  showSortDropdown=false">Duration ↑</button>
        <button class="drop-opt" [class.drop-opt-active]="sort()==='weeks-desc'" (click)="sort.set('weeks-desc'); showSortDropdown=false">Duration ↓</button>
      </div>
    </div>

    <!-- Reset -->
    <button class="btn-reset" type="button" (click)="resetFilters()"
            *ngIf="search() || type() !== 'all' || level() !== 'all' || sort() !== 'popular'">
      <mat-icon>restart_alt</mat-icon>
    </button>

  </div>

  <!-- ── INFO BAR ── -->
  <div class="info-bar">
    <span class="results-count">{{ startIndex() }}–{{ endIndex() }} of {{ totalCount() }} plans</span>
    <div class="page-size-group">
      <button *ngFor="let s of pageSizeOptions" type="button"
              class="ps-btn" [class.ps-btn-active]="pageSize() === s"
              (click)="setPageSize(s)">{{ s }}</button>
    </div>
  </div>

  <!-- ── CARDS GRID ── -->
  <div class="plans-grid">
    <div class="plan-card" *ngFor="let p of paged()">

      <div class="pc-img" [style.background-image]="'url(' + p.image + ')'">
        <div class="pc-img-overlay"></div>
        <div class="pc-badges">
          <span class="pc-badge" [ngClass]="'type-' + p.type">{{ p.type | titlecase }}</span>
          <span class="pc-badge" [ngClass]="'lvl-' + p.level">{{ p.level | titlecase }}</span>
        </div>
      </div>

      <div class="pc-body">
        <div class="pc-weeks">
          <mat-icon class="pc-weeks-ico">schedule</mat-icon>
          {{ p.weeks }} weeks
        </div>
        <h3 class="pc-title">{{ p.title }}</h3>
        <p class="pc-subtitle">{{ p.subtitle }}</p>
        <ul class="pc-perks">
          <li *ngFor="let perk of p.perks">
            <mat-icon>check_circle</mat-icon>
            <span>{{ perk }}</span>
          </li>
        </ul>
      </div>

      <div class="pc-footer">
        <div class="pc-price">
          <span class="pc-currency">$</span>{{ p.price }}
          <span class="pc-per">/ one-time</span>
        </div>
        <button type="button" class="btn-buy" (click)="buy(p)">
          <mat-icon>shopping_cart</mat-icon>
          Buy
        </button>
      </div>

    </div>
  </div>

  <!-- ── NO RESULTS ── -->
  <div *ngIf="filtered().length === 0" class="no-results">
    <mat-icon>search_off</mat-icon>
    <p>No plans match your criteria</p>
  </div>

  <!-- ── PAGINATION ── -->
  <div class="pagination-row" *ngIf="totalPages() > 1">
    <button type="button" class="pag-btn" (click)="setPage(page()-1)" [disabled]="page()===1">
      <mat-icon>chevron_left</mat-icon>
    </button>
    <button type="button" class="pag-btn"
            *ngFor="let num of pages()"
            [class.pag-btn-active]="page()===num"
            (click)="setPage(num)">{{ num }}</button>
    <button type="button" class="pag-btn" (click)="setPage(page()+1)" [disabled]="page()===totalPages()">
      <mat-icon>chevron_right</mat-icon>
    </button>
  </div>

</div>
