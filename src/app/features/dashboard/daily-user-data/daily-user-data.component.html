<div class="daily-root">
  <div class="section-header">
    <h2 class="section-title">Daily Tracker</h2>
    <p class="section-subtitle">Track your daily activities, nutrition, and progress</p>
  </div>

  <!-- Keep the form in the DOM to preserve layout height; show an overlay spinner while loading -->
  <div class="daily-content-wrapper" [class.loading]="facade.dailyDataLoading()">
    <form [formGroup]="form" class="daily-form" novalidate>

      <div class="cards-row">
        <mat-card class="card-col">
          <mat-card-title>Today</mat-card-title>
          <mat-card-content>
            <div class="date-pill">{{ form.get('date')?.value }}</div>

            <mat-form-field appearance="fill" class="full-width">
              <mat-label>Date</mat-label>
              <input matInput type="date" formControlName="date">
            </mat-form-field>

            <mat-form-field appearance="fill" class="full-width ">
              <mat-label>Activity Type</mat-label>
              <mat-select formControlName="activityType" class="activity-select">
                <mat-optgroup label="Standard">
                  <mat-option value="strength-training">Strength Training</mat-option>
                  <mat-option value="cardio">Cardio</mat-option>
                  <mat-option value="hiit-training">HIIT Training</mat-option>
                  <mat-option value="active-rest-day">Active Rest Day</mat-option>
                  <mat-option value="rest-day">Rest Day</mat-option>
                </mat-optgroup>

                <mat-optgroup label="My Workouts" *ngIf="workoutsFacade.templates.length > 0">
                  <mat-option
                    *ngFor="let w of workoutsFacade.templates"
                    [value]="'workout:' + w.uid">
                    {{ w.title }}<span class="workout-option-meta"> · {{ w.type }} · {{ w.durationMin }} min<ng-container *ngIf="w.caloriesEstimateKcal > 0"> · {{ w.caloriesEstimateKcal }} kcal</ng-container></span>
                  </mat-option>
                </mat-optgroup>
              </mat-select>
            </mat-form-field>

            <p class="muted">Choose what kind of day this is so you can better track your habits.</p>

            <div class="stat-row">
              <span>Calories burned</span>
              <strong>{{ facade.dailyDataStats().caloriesBurned }} kcal</strong>
            </div>

            <mat-form-field appearance="outline">
              <mat-label>Calories burned</mat-label>
              <input matInput type="number" min="0" formControlName="caloriesBurned" placeholder="Enter burned kcal">
            </mat-form-field>

            <div class="btn-row">
              <button mat-stroked-button class="primary" type="button" (click)="adjustCaloriesBurned(200)">+200</button>
              <button mat-stroked-button class="accent" type="button" (click)="adjustCaloriesBurned(-200)">−200</button>
            </div>

            <div class="net-row">
              <span>Net calories:</span>
              <!-- <span [class.text-success]="facade.dailyDataStats().netCalories < facade.dailyDataStats().totalCalories" [class.text-danger]="facade.dailyDataStats().netCalories > facade.dailyDataStats().totalCalories">{{ facade.dailyDataStats().netCalories }} kcal</span> -->
              <span class="net-calories">{{ facade.dailyDataStats().netCalories }} kcal</span>

            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="card-col">
          <mat-card-title>Calories & Macros</mat-card-title>
          <mat-card-content>
            <p class="muted">Estimated calories for today</p>
            <div class="big-number">{{ facade.dailyDataStats().totalCalories }} kcal</div>

            <fieldset formGroupName="macrosPct" class="macros-fieldset">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Protein (g)</mat-label>
                <input matInput type="number" formControlName="protein" min="0">
              </mat-form-field>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Carbs (g)</mat-label>
                <input matInput type="number" formControlName="carbs" min="0">
              </mat-form-field>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Fats (g)</mat-label>
                <input matInput type="number" formControlName="fats" min="0">
              </mat-form-field>
            </fieldset>

<!--
            <app-ai-meal-analyzer
              [disabled]="groqFacade.loading()"
              (added)="onMealAdded($event)"
             (error)="onMealAddedError($event)">
            </app-ai-meal-analyzer> -->
    <!-- ✅ Înlocuit componenta inline cu buton ANALYZE -->

            <div class="btn-analyze">
              <button mat-flat-button class="btn-primary" type="button"
                      (click)="openMealAnalyze()" [disabled]="groqFacade.loading()">
                <mat-icon>analytics</mat-icon>
                ANALYZE
              </button>
              <span class="flex-spacer"></span>
            </div>


          </mat-card-content>
        </mat-card>

        <mat-card class="card-col">
          <mat-card-title>Water & Steps</mat-card-title>
          <mat-card-content>
            <div class="progress-header">
              <span class="progress-label">Water Intake</span>
              <span class="progress-value">{{ facade.dailyDataStats().waterConsumedL | number:'1.1-1' }} L / {{ facade.waterTargetFromMetrics() | number:'1.1-1' }} L</span>
            </div>
            <mat-progress-bar mode="determinate" [value]="facade.waterProgress()" class="custom-progress"></mat-progress-bar>
            <div class="progress-percentage">{{ (facade.waterProgress() || 0) | number:'1.0-0' }}% complete</div>

            <div class="btn-row">
              <button mat-stroked-button class="primary" (click)="facade.addWater(0.25)">+250 ml</button>
              <button mat-stroked-button class="primary" (click)="facade.addWater(0.5)">+500 ml</button>
              <button mat-stroked-button class="accent" (click)="facade.addWater(-0.25)">−250 ml</button>
            </div>

            <div class="progress-header">
              <span class="progress-label">Steps</span>
              <span class="progress-value">{{ facade.dailyDataStats().steps | number:'1.0-0' }} / {{ facade.dailyDataStats().stepTarget | number:'1.0-0' }} steps</span>
            </div>
            <mat-progress-bar mode="determinate" [value]="facade.dailyDataStats().stepsProgress" class="custom-progress"></mat-progress-bar>
            <div class="progress-percentage">{{ facade.dailyDataStats().stepsProgress | number:'1.0-0' }}% complete</div>

            <div class="btn-row">
              <button mat-stroked-button class="primary" (click)="facade.addSteps(500)">+500</button>
              <button mat-stroked-button class="primary" (click)="facade.addSteps(1000)">+1000</button>
              <button mat-stroked-button class="accent" (click)="facade.addSteps(-500)">−500</button>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

      <div class="action-row">
        <!-- <button mat-flat-button color="primary" class="primary-button" (click)="onSaveData()">Save</button> -->
        <button *ngIf="isTodaySelected" color="accent" mat-stroked-button class="stroke-button" (click)="onReset()">Reset</button>
      </div>

    </form>

    <div *ngIf="facade.dailyDataLoading()" class="loading-overlay">
      <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
    </div>
  </div>

    <!-- OVERLAY MODAL  -->
  <div *ngIf="showAnalyzeOverlay" class="overlay-backdrop" (click)="closeMealAnalyze()">
    <mat-card class="overlay-card" (click)="$event.stopPropagation()">
      <mat-card-header>
        <mat-card-title>Analyze Meal</mat-card-title>
           <span class="flex-spacer"></span>
      <button
        mat-mini-fab
        class="overlay-cancel-btn"
        type="button"
        (click)="closeMealAnalyze()"
      >
        <mat-icon>close</mat-icon>
      </button>
      </mat-card-header>

      <mat-card-content>
        <app-ai-meal-analyzer
          (added)="onAnalyzerAdded($event)"
          (error)="onAnalyzerError($event)">
        </app-ai-meal-analyzer>

        <mat-hint *ngIf="analyzeError" class="error">{{ analyzeError }}</mat-hint>
      </mat-card-content>
    </mat-card>
  </div>
</div>
