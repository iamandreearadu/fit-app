<div class="daily-root">

  <!-- Picker backdrop (closes picker when clicking outside) -->
  <div *ngIf="showActivityPicker" class="picker-bd" (click)="showActivityPicker = false"></div>

  <form [formGroup]="form" novalidate>

    <!-- ── CONTROL BAR ── -->
    <div class="ctrl-wrap">
      <div class="ctrl-bar">

        <div class="ctrl-section">
          <mat-icon class="ctrl-ico">calendar_today</mat-icon>
          <div class="ctrl-body">
            <span class="ctrl-lbl">Today</span>
            <span class="ctrl-val">{{ facade.todayDate | date:'EEE, d MMM' }}</span>
          </div>
        </div>

        <div class="ctrl-sep"></div>

        <div class="ctrl-section ctrl-grow" (click)="showActivityPicker = !showActivityPicker">
          <mat-icon class="ctrl-ico">{{ currentActivityDisplay.icon }}</mat-icon>
          <div class="ctrl-body">
            <span class="ctrl-lbl">Activity</span>
            <span class="ctrl-val">{{ currentActivityDisplay.label }}</span>
          </div>
          <mat-icon class="ctrl-chevron">{{ showActivityPicker ? 'expand_less' : 'expand_more' }}</mat-icon>
        </div>

        <div class="ctrl-sep"></div>

        <button class="ctrl-section ctrl-ai" type="button"
                (click)="openMealAnalyze()" [disabled]="groqFacade.loading()">
          <div class="ctrl-ai-icon">
            <mat-icon>auto_awesome</mat-icon>
          </div>
          <div class="ctrl-body">
            <span class="ctrl-lbl">AI</span>
            <span class="ctrl-val">Analyze</span>
          </div>
        </button>

        <div class="ctrl-end">
          <span class="save-badge"
                [class.sb-visible]="autoSaveStatus !== 'idle'"
                [class.sb-saving]="autoSaveStatus === 'saving'"
                [class.sb-saved]="autoSaveStatus === 'saved'"
                [class.sb-error]="autoSaveStatus === 'error'">
            <mat-icon *ngIf="autoSaveStatus === 'saving'">sync</mat-icon>
            <mat-icon *ngIf="autoSaveStatus === 'saved'">check_circle</mat-icon>
            <mat-icon *ngIf="autoSaveStatus === 'error'">error_outline</mat-icon>
          </span>
          <button mat-icon-button class="btn-reset" type="button"
                  (click)="onReset()" matTooltip="Reset today">
            <mat-icon>restart_alt</mat-icon>
          </button>
        </div>

      </div>

      <!-- ── ACTIVITY PICKER PANEL ── -->
      <div *ngIf="showActivityPicker" class="act-panel" (click)="$event.stopPropagation()">
        <div class="act-group-lbl">Standard</div>
        <button *ngFor="let opt of activityOptions" class="act-opt" type="button"
                [class.act-active]="form.get('activityType')?.value === opt.value"
                (click)="selectActivity(opt.value)">
          <mat-icon class="act-ico">{{ opt.icon }}</mat-icon>
          <span>{{ opt.label }}</span>
        </button>
        <ng-container *ngIf="workoutsFacade.templates.length > 0">
          <div class="act-divider"></div>
          <div class="act-group-lbl">My Workouts</div>
          <button *ngFor="let w of workoutsFacade.templates" class="act-opt" type="button"
                  [class.act-active]="form.get('activityType')?.value === 'workout:' + w.uid"
                  (click)="selectActivity('workout:' + w.uid)">
            <mat-icon class="act-ico">sports</mat-icon>
            <span>{{ w.title }}</span>
          </button>
        </ng-container>
      </div>
    </div>

    <!-- ── STATS BAR ── -->
    <div class="stats-bar">

      <div class="sbar-item">
        <mat-icon class="sbar-ico si-purple">restaurant</mat-icon>
        <span class="sbar-val sv-purple">{{ facade.dailyDataStats().totalCalories }}</span>
        <span class="sbar-lbl">Cal In</span>
      </div>

      <div class="sbar-sep"></div>

      <div class="sbar-item">
        <mat-icon class="sbar-ico si-orange">local_fire_department</mat-icon>
        <span class="sbar-val sv-orange">{{ facade.dailyDataStats().caloriesBurned }}</span>
        <span class="sbar-lbl">Burned</span>
      </div>

      <div class="sbar-sep"></div>

      <div class="sbar-item sbar-net">
        <mat-icon class="sbar-ico si-white">balance</mat-icon>
        <span class="sbar-val sv-white">{{ facade.dailyDataStats().netCalories }}</span>
        <span class="sbar-lbl">Net Cal</span>
      </div>

      <div class="sbar-sep"></div>

      <div class="sbar-item">
        <mat-icon class="sbar-ico si-blue">water_drop</mat-icon>
        <span class="sbar-val sv-blue">{{ facade.dailyDataStats().waterConsumedL | number:'1.2-2' }} L</span>
        <span class="sbar-lbl">Water</span>
      </div>

      <div class="sbar-sep"></div>

      <div class="sbar-item">
        <mat-icon class="sbar-ico si-green">directions_walk</mat-icon>
        <span class="sbar-val sv-green">{{ facade.dailyDataStats().steps | number:'1.0-0' }}</span>
        <span class="sbar-lbl">Steps</span>
      </div>

    </div>

    <!-- ── CONTENT GRID ── -->
    <div class="content-grid">

      <!-- NUTRITION -->
      <div class="card">
        <div class="card-head">
          <div class="card-head-left">
            <div class="card-icon-wrap ci-purple">
              <mat-icon>restaurant_menu</mat-icon>
            </div>
            <span class="card-title">Nutrition</span>
          </div>
          <span class="card-badge b-purple">{{ facade.dailyDataStats().totalCalories }} kcal</span>
        </div>

        <fieldset formGroupName="macrosPct" class="macros-list">
          <div class="macro-row">
            <span class="mdot d-protein"></span>
            <mat-form-field appearance="outline" subscriptSizing="dynamic" class="mf">
              <mat-label>Protein (g)</mat-label>
              <input matInput type="number" formControlName="protein" min="0">
            </mat-form-field>
          </div>
          <div class="macro-row">
            <span class="mdot d-carbs"></span>
            <mat-form-field appearance="outline" subscriptSizing="dynamic" class="mf">
              <mat-label>Carbs (g)</mat-label>
              <input matInput type="number" formControlName="carbs" min="0">
            </mat-form-field>
          </div>
          <div class="macro-row">
            <span class="mdot d-fats"></span>
            <mat-form-field appearance="outline" subscriptSizing="dynamic" class="mf">
              <mat-label>Fats (g)</mat-label>
              <input matInput type="number" formControlName="fats" min="0">
            </mat-form-field>
          </div>
        </fieldset>

      </div>

      <!-- CALORIES BURNED -->
      <div class="card">
        <div class="card-head">
          <div class="card-head-left">
            <div class="card-icon-wrap ci-orange">
              <mat-icon>local_fire_department</mat-icon>
            </div>
            <span class="card-title">Calories Burned</span>
          </div>
          <span class="card-badge b-orange">{{ facade.dailyDataStats().caloriesBurned }} kcal</span>
        </div>

        <mat-form-field appearance="outline" subscriptSizing="dynamic" class="full-f">
          <mat-label>Manual entry</mat-label>
          <input matInput type="number" min="0" formControlName="caloriesBurned">
          <mat-icon matSuffix>edit</mat-icon>
        </mat-form-field>

        <div class="adj-row">
          <button mat-stroked-button class="ab ab-p" type="button" (click)="adjustCaloriesBurned(200)">+200</button>
          <button mat-stroked-button class="ab ab-p" type="button" (click)="adjustCaloriesBurned(100)">+100</button>
          <button mat-stroked-button class="ab ab-m" type="button" (click)="adjustCaloriesBurned(-100)">−100</button>
          <button mat-stroked-button class="ab ab-m" type="button" (click)="adjustCaloriesBurned(-200)">−200</button>
        </div>

        <div class="net-row">
          <span class="net-label"><mat-icon>calculate</mat-icon> Net Calories</span>
          <span class="net-value">{{ facade.dailyDataStats().netCalories }} kcal</span>
        </div>
      </div>

      <!-- HYDRATION & STEPS -->
      <div class="card">
        <div class="card-head">
          <div class="card-head-left">
            <div class="card-icon-wrap ci-blue">
              <mat-icon>self_improvement</mat-icon>
            </div>
            <span class="card-title">Hydration & Steps</span>
          </div>
        </div>

        <!-- Water -->
        <div class="track">
          <div class="track-header">
            <span class="track-name"><mat-icon class="t-icon t-blue">water_drop</mat-icon> Water</span>
            <span class="track-frac t-blue">
              {{ facade.dailyDataStats().waterConsumedL | number:'1.2-2' }} / {{ facade.waterTargetFromMetrics() | number:'1.1-1' }} L
            </span>
          </div>
          <mat-progress-bar class="pbar pbar-blue" mode="determinate" [value]="facade.waterProgress()"></mat-progress-bar>
          <div class="adj-row">
            <button mat-stroked-button class="ab ab-p" type="button" (click)="adjustWaterMl(500)">+500 ml</button>
            <button mat-stroked-button class="ab ab-p" type="button" (click)="adjustWaterMl(250)">+250 ml</button>
            <button mat-stroked-button class="ab ab-m" type="button" (click)="adjustWaterMl(-250)">−250 ml</button>
          </div>
        </div>

        <div class="track-divider"></div>

        <!-- Steps -->
        <div class="track">
          <div class="track-header">
            <span class="track-name"><mat-icon class="t-icon t-green">directions_walk</mat-icon> Steps</span>
            <span class="track-frac t-green">
              {{ facade.dailyDataStats().steps | number:'1.0-0' }} / {{ facade.dailyDataStats().stepTarget | number:'1.0-0' }}
            </span>
          </div>
          <mat-progress-bar class="pbar pbar-green" mode="determinate" [value]="facade.dailyDataStats().stepsProgress"></mat-progress-bar>
          <div class="adj-row">
            <button mat-stroked-button class="ab ab-p" type="button" (click)="adjustSteps(1000)">+1 000</button>
            <button mat-stroked-button class="ab ab-p" type="button" (click)="adjustSteps(500)">+500</button>
            <button mat-stroked-button class="ab ab-m" type="button" (click)="adjustSteps(-500)">−500</button>
          </div>
        </div>

      </div>

    </div>

  </form>

  <!-- Loading overlay -->
  <div *ngIf="facade.dailyDataLoading()" class="load-overlay">
    <mat-progress-spinner mode="indeterminate" diameter="40"></mat-progress-spinner>
  </div>

  <!-- Analyze Modal -->
  <div *ngIf="showAnalyzeOverlay" class="modal-bg" (click)="closeMealAnalyze()">
    <div class="modal-box" (click)="$event.stopPropagation()">
      <div class="modal-head">
        <div class="modal-icon-wrap">
          <mat-icon>auto_awesome</mat-icon>
        </div>
        <span class="modal-title">Analyze Meal with AI</span>
        <button mat-icon-button class="modal-close" type="button" (click)="closeMealAnalyze()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <app-ai-meal-analyzer
        (added)="onAnalyzerAdded($event)"
        (error)="onAnalyzerError($event)">
      </app-ai-meal-analyzer>
      <div *ngIf="analyzeError" class="modal-err">{{ analyzeError }}</div>
    </div>
  </div>

</div>
