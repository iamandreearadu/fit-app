<div *ngIf="loading" class="loading-container">
  <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
</div>

<div *ngIf="!loading" class="blog-root">
  <div class="section-header">
    <h2 class="section-title">Blog Posts</h2>
    <p class="section-subtitle">Explore articles, tips, and insights</p>
  </div>

  <div class="controls-row">
    <mat-form-field appearance="outline" class="search-field">
      <mat-label>Search</mat-label>
      <input matInput placeholder="Search in title, subtitle or description" [(ngModel)]="searchTerm" (ngModelChange)="applyFilters()" />
      <mat-icon matSuffix>search</mat-icon>
    </mat-form-field>

    <mat-form-field appearance="outline" class="category-field">
      <mat-label>Category</mat-label>
      <mat-select [(ngModel)]="selectedCategory" (selectionChange)="applyFilters()">
        <mat-option value="all">All categories</mat-option>
        <mat-option *ngFor="let c of categories" [value]="c">{{ c }}</mat-option>
      </mat-select>
    </mat-form-field>

    <div class="actions">
      <button *ngIf="isOwner" mat-flat-button color="primary" (click)="openCreate()">
        <mat-icon>add</mat-icon>
        New Post
      </button>
    </div>
  </div>

  <div class="posts-grid">

    <mat-card *ngFor="let p of filtered" class="post-card" >

  <div *ngIf="isOwner" class="admin-actions">
    <button
      mat-icon-button
      (click)="openEdit(p)"
      aria-label="Edit post"
    >
      <mat-icon>edit</mat-icon>
    </button>

    <button
      mat-icon-button
      (click)="deletePost(p.uid)"
      aria-label="Delete post"
      color="accent"
    >
      <mat-icon>delete</mat-icon>
    </button>
  </div>

  <div 
    class="img-holder"
    [style.background-image]="'url(' + (p.image || 'https://images.unsplash.com/photo-1522202176988-66273c2fd55f?q=80') + ')'"
    [routerLink]="['/blog', p.uid]"
    ></div>

  <mat-card-content [routerLink]="['/blog', p.uid]">
    <mat-chip-set class="category-chip">
      <mat-chip class="chip">{{ p.category }}</mat-chip>
    </mat-chip-set>

    <h3 class="post-title">{{ p.title }}</h3>
    <p class="post-caption">{{ p.caption }}</p>

    <div class="post-actions">
      <button mat-icon-button  [routerLink]="['/blog', p.uid]">
        <mat-icon>visibility</mat-icon>
      </button>
    </div>
  </mat-card-content>

</mat-card>

  </div>

  <div *ngIf="filtered.length === 0" class="no-results">
    <mat-icon>search_off</mat-icon>
    <p>No posts found matching your criteria</p>
  </div>



  <div *ngIf="showCreateOverlay || editing" class="overlay-backdrop" (click)="showCreateOverlay = false; editing = false">
    <mat-card class="overlay-card" (click)="$event.stopPropagation()">
      <mat-card-header>
        <mat-card-title>{{ editModel.id ? 'Edit Post' : 'Create New Post' }}</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Title</mat-label>
          <input matInput [(ngModel)]="editModel.title" />
        </mat-form-field>
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Subtitle</mat-label>
          <input matInput [(ngModel)]="editModel.caption" />
        </mat-form-field>
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Category</mat-label>
          <input matInput [(ngModel)]="editModel.category" />
        </mat-form-field>
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Image URL</mat-label>
          <input matInput [(ngModel)]="editModel.image" />
        </mat-form-field>
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Description</mat-label>
          <textarea matInput rows="6" [(ngModel)]="editModel.description"></textarea>
        </mat-form-field>
      </mat-card-content>
      <mat-card-actions>
        <button mat-stroked-button color="accent" (click)="showCreateOverlay = false; editing = false; cancelEdit()">
          <mat-icon>close</mat-icon>
          Cancel
        </button>
        <button mat-flat-button color="primary" (click)="createOrUpdatePost()">
          <mat-icon>save</mat-icon>
          Save
        </button>
      </mat-card-actions>
    </mat-card>
  </div>
</div>
